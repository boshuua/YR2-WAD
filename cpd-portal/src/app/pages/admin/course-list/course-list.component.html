<div class="user-management-panel">

  <div class="panel-header">
    <div class="header-left">
      <h2>Course Management</h2>
      <div class="tabs">
        <button class="tab-btn" [class.active]="currentTab === 'active'" (click)="switchTab('active')">Active
          Schedules</button>
        <button class="tab-btn" [class.active]="currentTab === 'library'" (click)="switchTab('library')">Course
          Library</button>
      </div>
    </div>
    <!-- Only show Add button for Active Tab (Scheduling) -->
    <button *ngIf="currentTab === 'active'" class="add-user-btn" (click)="addCourse()">
      + Schedule Course
    </button>
  </div>

  <div class="table-responsive">
    <div *ngIf="isLoading" class="loading-state">Loading courses...</div>
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

    <!-- Active Tab: Split View -->
    <div *ngIf="!isLoading && !errorMessage && currentTab === 'active'">

      <!-- Upcoming Section -->
      <h3 class="section-title">Upcoming Scheduled Courses</h3>
      <table *ngIf="upcomingCourses.length > 0; else noUpcoming">
        <thead>
          <tr>
            <th>Title</th>
            <th>Dates</th>
            <th>Enrolled</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let course of upcomingCourses">
            <td data-label="Title">{{ course.title }}</td>
            <td data-label="Dates">{{ course.start_date | date }} - {{ course.end_date | date }}</td>
            <td data-label="Enrolled">
              {{ course.enrolled_count || 0 }} / {{ course.max_attendees }}
              <span *ngIf="(course.enrolled_count || 0) >= (course.max_attendees ?? 0)" class="badge badge-warning">FULL</span>
            </td>
            <td data-label="Actions" class="actions-cell">
              <!-- Edit Disabled for Scheduled Courses -->
              <button class="edit-btn" disabled title="Cannot edit scheduled course properties">Edit</button>
              <button class="enroll-btn" (click)="openEnrollModal(course.id)">Enroll</button>
              <button class="delete-btn" (click)="promptDeleteCourse(course.id, course.title)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
      <ng-template #noUpcoming>
        <p class="no-data-param">No upcoming courses scheduled.</p>
      </ng-template>

      <!-- Past Section REMOVED as per request -->

    </div>

    <!-- Library Tab: Standard View -->
    <div *ngIf="!isLoading && !errorMessage && currentTab === 'library'">
      <table *ngIf="courses.length > 0; else noLibrary">
        <thead>
          <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let course of courses" [class.locked-row]="course.is_locked">
            <td data-label="Title">
              {{ course.title }}
              <span *ngIf="course.is_locked" class="badge badge-warning">LOCKED</span>
            </td>
            <td data-label="Description">{{ course.description | slice:0:100 }}...</td>
            <td data-label="Type">
              {{ course.is_locked ? 'System' : (course.is_template ? 'Template' : 'Course') }}
            </td>
            <td data-label="Actions" class="actions-cell">
              <button class="edit-btn" (click)="editCourse(course.id)" [disabled]="course.is_locked">Edit</button>
              <button class="info-btn" (click)="manageQuestions(course.id)"
                [disabled]="course.is_locked">Questions</button>
              <button class="delete-btn" (click)="promptDeleteCourse(course.id, course.title)"
                [disabled]="course.is_locked">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
      <ng-template #noLibrary>
        <div class="no-data-message">No courses in library.</div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Schedule Modal -->
<div class="modal-backdrop" *ngIf="showScheduleModal">
  <div class="modal-content">
    <h3>Schedule Course from Template</h3>
    <form [formGroup]="scheduleForm" (ngSubmit)="scheduleCourse()">
      <div class="form-group">
        <label>Select Template</label>
        <select formControlName="templateId" required>
          <option [ngValue]="null" disabled>-- Select a Template --</option>
          <option *ngFor="let t of templates" [value]="t.id">{{ t.title }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Start Date</label>
        <input type="date" formControlName="startDate" required>
      </div>

      <div class="form-group">
        <label>End Date</label>
        <input type="date" formControlName="endDate" required>
      </div>

      <div class="form-group">
        <label>Custom Title (Optional)</label>
        <input type="text" formControlName="title" placeholder="Leave blank to use template title">
      </div>

      <div class="form-group">
        <label>Assign to Users (Optional)</label>
        <input type="text" [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}" placeholder="Search users by name or email..."
          class="search-input">

        <div class="user-select-list">
          <div *ngFor="let user of filteredUsers" class="user-checkbox-item">
            <input type="checkbox" [id]="'user-'+user.id" (change)="toggleUserSelection(user.id, $event)"
              [checked]="scheduleForm.get('userIds')?.value?.includes(user.id)">
            <label [for]="'user-'+user.id">
              {{ user.first_name }} {{ user.last_name }} <span class="email-hint">({{ user.email }})</span>
            </label>
          </div>
          <div *ngIf="filteredUsers.length === 0" class="no-users-found">No users found.</div>
        </div>
        <small class="hint">Selected users will be enrolled immediately.</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeScheduleModal()">Cancel</button>
        <button type="submit" class="confirm-btn" [disabled]="isScheduling || scheduleForm.invalid">
          {{ isScheduling ? 'Scheduling...' : 'Schedule Course' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Enroll User Modal -->
<div class="modal-backdrop" *ngIf="showEnrollModal">
  <div class="modal-content">
    <h3>Enroll User in Course</h3>
    <form (ngSubmit)="enrollUser()">
      <div class="form-group">
        <label>Select User</label>

        <!-- User Search Input Filter -->
        <input type="text" [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}" placeholder="Search for user..."
          class="search-input" style="margin-bottom: 10px; width: 100%;">

        <select [(ngModel)]="enrollUserId" [ngModelOptions]="{standalone: true}" required size="5" style="height: auto;">
          <option [ngValue]="null" disabled>-- Select User --</option>
          <option *ngFor="let user of filteredUsers" [value]="user.id">
            {{ user.first_name }} {{ user.last_name }} ({{ user.email }})
          </option>
        </select>
        <div *ngIf="filteredUsers.length === 0" class="no-users-found" style="margin-top:5px; color:#666;">No users
          match your search.</div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeEnrollModal()">Cancel</button>
        <button type="submit" class="confirm-btn" [disabled]="isEnrolling">
          {{ isEnrolling ? 'Enrolling...' : 'Enroll User' }}
        </button>
      </div>
    </form>
  </div>
</div>

<app-confirm-modal [isVisible]="showDeleteConfirmModal" title="Confirm Deletion"
  [message]="'Are you sure you want to delete the course \'' + courseToDeleteTitle + '\'?'"
  confirmButtonText="Delete Course" cancelButtonText="Cancel" (confirmed)="confirmDelete()"
  (cancelled)="cancelDelete()">
</app-confirm-modal>