<div class="user-management-panel">

  <div class="panel-header">
    <div class="header-left">
      <h2>Course Management</h2>
      <div class="tabs">
        <button class="tab-btn" [class.active]="currentTab === 'active'" (click)="switchTab('active')">Active
          Schedules</button>
        <button class="tab-btn" [class.active]="currentTab === 'library'" (click)="switchTab('library')">Course
          Library</button>
      </div>
    </div>
    <!-- Only show Add button for Active Tab (Scheduling) -->
    <button *ngIf="currentTab === 'active'" class="add-user-btn" (click)="addCourse()">
      + Schedule Course
    </button>
  </div>

  <div class="table-responsive">
    <div *ngIf="isLoading" class="loading-state">Loading courses...</div>
    <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

    <table *ngIf="!isLoading && !errorMessage && courses.length > 0">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th *ngIf="currentTab === 'active'">Dates</th>
          <th *ngIf="currentTab === 'library'">Type</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let course of courses" [class.locked-row]="course.is_locked">
          <td data-label="Title">
            {{ course.title }}
            <span *ngIf="course.is_locked" class="badge badge-warning" style="margin-left:5px;">LOCKED</span>
          </td>
          <td data-label="Description">{{ course.description | slice:0:100 }}{{ course.description.length > 100 ? '...'
            : '' }}</td>
          <td *ngIf="currentTab === 'active'" data-label="Dates">
            {{ course.start_date | date }} - {{ course.end_date | date }}
          </td>
          <td *ngIf="currentTab === 'library'" data-label="Type">
            {{ course.is_locked ? 'System' : (course.is_template ? 'Template' : 'Course') }}
          </td>
          <td data-label="Actions" class="actions-cell">
            <button class="edit-btn" (click)="editCourse(course.id)" [disabled]="course.is_locked"
              title="Edit">Edit</button>
            <button class="info-btn" (click)="manageQuestions(course.id)" [disabled]="course.is_locked"
              title="Questions">Questions</button>
            <button *ngIf="currentTab === 'active'" class="enroll-btn" (click)="openEnrollModal(course.id)"
              title="Enroll User">Enroll</button>
            <button class="delete-btn" (click)="promptDeleteCourse(course.id, course.title)"
              [disabled]="course.is_locked" title="Delete">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!isLoading && noCoursesFound" class="no-data-message">
      No {{ currentTab === 'active' ? 'active courses' : 'courses' }} found.
      <span *ngIf="currentTab === 'active'">Click '+ Schedule Course' to add one.</span>
    </div>
  </div>
</div>

<!-- Schedule Modal -->
<div class="modal-backdrop" *ngIf="showScheduleModal">
  <div class="modal-content">
    <h3>Schedule Course from Template</h3>
    <form (ngSubmit)="scheduleCourse()">
      <div class="form-group">
        <label>Select Template</label>
        <select [(ngModel)]="scheduleData.templateId" name="templateId" required>
          <option [ngValue]="null" disabled>-- Select a Template --</option>
          <option *ngFor="let t of templates" [value]="t.id">{{ t.title }}</option>
        </select>
      </div>

      <div class="form-group">
        <label>Start Date</label>
        <input type="date" [(ngModel)]="scheduleData.startDate" name="startDate" required>
      </div>

      <div class="form-group">
        <label>End Date</label>
        <input type="date" [(ngModel)]="scheduleData.endDate" name="endDate" required>
      </div>

      <div class="form-group">
        <label>Custom Title (Optional)</label>
        <input type="text" [(ngModel)]="scheduleData.title" name="title"
          placeholder="Leave blank to use template title">
      </div>

      <div class="form-group">
        <label>Assign to Users (Optional)</label>
        <div class="user-select-list">
          <div *ngFor="let user of users" class="user-checkbox-item">
            <input type="checkbox" [id]="'user-'+user.id" (change)="toggleUserSelection(user.id, $event)"
              [checked]="scheduleData.userIds.includes(user.id)">
            <label [for]="'user-'+user.id">
              {{ user.first_name }} {{ user.last_name }} <span class="email-hint">({{ user.email }})</span>
            </label>
          </div>
        </div>
        <small class="hint">Selected users will be enrolled immediately.</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeScheduleModal()">Cancel</button>
        <button type="submit" class="confirm-btn" [disabled]="isScheduling">
          {{ isScheduling ? 'Scheduling...' : 'Schedule Course' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Enroll User Modal -->
<div class="modal-backdrop" *ngIf="showEnrollModal">
  <div class="modal-content">
    <h3>Enroll User in Course</h3>
    <form (ngSubmit)="enrollUser()">
      <div class="form-group">
        <label>Select User</label>
        <select [(ngModel)]="enrollData.userId" name="userId" required>
          <option [ngValue]="null" disabled>-- Select User --</option>
          <option *ngFor="let user of users" [value]="user.id">
            {{ user.first_name }} {{ user.last_name }} ({{ user.email }})
          </option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeEnrollModal()">Cancel</button>
        <button type="submit" class="confirm-btn" [disabled]="isEnrolling">
          {{ isEnrolling ? 'Enrolling...' : 'Enroll User' }}
        </button>
      </div>
    </form>
  </div>
</div>

<app-confirm-modal [isVisible]="showDeleteConfirmModal" title="Confirm Deletion"
  [message]="'Are you sure you want to delete the course \'' + courseToDeleteTitle + '\'?'"
  confirmButtonText="Delete Course" cancelButtonText="Cancel" (confirmed)="confirmDelete()"
  (cancelled)="cancelDelete()">
</app-confirm-modal>