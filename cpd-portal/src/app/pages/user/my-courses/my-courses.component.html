<div class="user-dashboard-container">
  <h1>My Learning Dashboard</h1>

  <!-- Search Section -->
  <div class="filters-section">
    <div class="search-box">
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)"
        placeholder="Search courses..." class="search-input" />
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-message">Loading courses...</div>
  <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

  <div *ngIf="!isLoading && !errorMessage">

    <!-- 1. Active Training -->
    <section class="course-section">
      <h2>My Enrolled Training</h2>
      <div *ngIf="filteredActive.length > 0; else noActive" class="course-list">
        <div *ngFor="let course of filteredActive" class="course-card active-card">
          <div class="card-header">
            <h3>{{ course.title }}</h3>
            <span class="badge badge-info">In Progress</span>
          </div>
          <p class="course-description">{{ course.description | slice:0:150 }}...</p>
          <div class="course-meta">
            <span *ngIf="course.enrolled_at">Enrolled: {{ course.enrolled_at | date }}</span>
          </div>
          <div class="course-actions">
            <a class="btn-primary" [routerLink]="getResumeLink(course)">Continue Training</a>
            <span class="progress-hint">Score: {{ course.score || 0 }}%</span>
          </div>
        </div>
      </div>
      <ng-template #noActive>
        <p class="empty-section">You have no active training at the moment.</p>
      </ng-template>
    </section>

    <!-- 2. Available Training -->
    <section class="course-section">
      <h2>Available Training (Upcoming)</h2>
      <div *ngIf="filteredAvailable.length > 0; else noAvailable" class="course-list">
        <div *ngFor="let course of filteredAvailable" class="course-card available-card">
          <div class="card-header">
            <h3>{{ course.title }}</h3>
            <span class="badge badge-default">Upcoming</span>
          </div>
          <p class="course-description">{{ course.description | slice:0:150 }}...</p>
          <div class="course-meta">
            <span class="date-badge">Starts: {{ course.start_date | date }}</span>
            <span class="capacity-badge" [class.full]="isFull(course)">
              {{ course.enrolled_count || 0 }} of {{ course.max_attendees }} spaces booked
            </span>
          </div>
          <div class="course-actions">
            <button *ngIf="!isFull(course)" class="btn-success" (click)="enrollCourse(course.id)">Enroll Now</button>
            <button *ngIf="isFull(course)" class="btn-disabled" disabled>Course Full</button>
          </div>
        </div>
      </div>
      <ng-template #noAvailable>
        <p class="empty-section">No upcoming courses available.</p>
      </ng-template>
    </section>

    <!-- 3. Training History -->
    <section class="course-section">
      <h2>Training History</h2>
      <div *ngIf="filteredHistory.length > 0; else noHistory" class="course-list">
        <div *ngFor="let course of filteredHistory" class="course-card history-card">
          <div class="card-header">
            <h3>{{ course.title }}</h3>
            <span class="badge badge-success">Completed</span>
          </div>
          <div class="course-meta">
            <span>Completed: {{ course.completion_date | date }}</span>
            <span class="score-badge">Final Score: {{ course.score }}%</span>
          </div>
          <div class="course-actions">
            <span class="completed-msg">✓ Certificate Available</span>
          </div>
        </div>
      </div>
      <ng-template #noHistory>
        <p class="empty-section">No completed training yet.</p>
      </ng-template>
    </section>

    <!-- 4. Exam History -->
    <section class="course-section exam-history-section">
      <h2>MOT Exam History</h2>
      <div *ngIf="examHistory.length > 0; else noExams" class="exam-list">
        <div *ngFor="let exam of examHistory" class="exam-card" [class.passed]="exam.passed"
          [class.failed]="!exam.passed">
          <div class="exam-header">
            <h3>{{ exam.title }}</h3>
            <span class="exam-date">{{ exam.completion_date | date:'shortDate' }}</span>
          </div>
          <div class="exam-result">
            <span class="exam-score">{{ exam.score }}%</span>
            <span *ngIf="exam.passed" class="result-icon">✓</span>
            <span *ngIf="!exam.passed" class="result-icon">✗</span>
          </div>
        </div>
      </div>
      <ng-template #noExams>
        <p class="empty-section">No exams completed yet.</p>
      </ng-template>
    </section>

  </div>
</div>